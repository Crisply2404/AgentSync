# 技术设计: SSH 一键向导（目标端免安装）

## 技术方案

### 核心技术
- Tauri v2（Rust 后端 + 前端页面）
- 仍然使用现有 rclone + SFTP(SSH) 同步逻辑
- 通过系统自带 `ssh-keygen` 生成/读取公钥（不在工具里实现复杂的加密细节）

### 实现要点
- 后端新增 2 个 command：
  1. `ssh_keypair_ensure`：在本机 `~/.agentsync/keys/` 下确保存在一对 ed25519 密钥（不存在就生成），并返回私钥路径与公钥文本
  2. `ssh_public_key_read`：给定私钥路径，读取对应公钥（优先读 `*.pub`，没有就用 `ssh-keygen -y -f` 生成）
- 前端新增“设备向导”页面：
  - 一键生成/选择密钥（并显示公钥）
  - 输入 Host/User/Port 与目标端目录（沿用现有 config 字段）
  - 根据目标端系统生成“一次性初始化命令”（主要面向 macOS/Linux）
  - 引导用户“目标端执行命令 → 本机测试连接 → 保存配置”

## 架构决策 ADR

### ADR-001: “目标端免安装”优先采用复制粘贴脚本，而不是让 App 自动 ssh 进去写入 authorized_keys
**上下文:** 用户想省事，但自动安装公钥通常需要输入密码/管理员权限，还会引入“密码怎么处理/怎么不落盘/怎么交互”的复杂度。
**决策:** 本轮先做“复制粘贴一次性命令”的方式，目标端只需要执行一次即可完成授权与目录创建。
**理由:** 实现更稳、更透明、跨平台更容易，且符合“不保存密码”的安全目标。
**替代方案:** App 里让用户输入一次性密码，然后自动执行类似 `ssh-copy-id` 的流程 → 拒绝原因: 交互复杂、风险更高、跨平台坑多（尤其 Windows）。
**影响:** 目标端仍需要一次手动操作（开启 SSH + 粘贴命令），但已经比“自己研究 SSH”简单很多。

## API设计

### Tauri Command: `ssh_keypair_ensure`
- **请求:** 无
- **响应:** `{ privateKeyPath: string, publicKey: string }`

### Tauri Command: `ssh_public_key_read`
- **请求:** `{ privateKeyPath: string }`
- **响应:** `string`（公钥一行文本）

## 安全与性能
- **安全:**
  - 不在配置文件里保存密码
  - 私钥只保存到本机 `~/.agentsync/keys/`，前端不读取私钥内容
  - 镜像删除保持“先备份再删除”的策略（rclone `--backup-dir`）
- **性能:** 生成密钥是一次性操作；同步性能保持不变

## 测试与部署
- **测试:**
  - `cargo check` 确保 Rust 侧编译通过
  - `npm run build` 确保前端构建通过
- **部署:** 本轮仍以开发版验证为主，后续再补打包与安装流程文档

